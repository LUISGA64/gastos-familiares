{% extends 'gastos/base.html' %}

{% block title %}Historial de Conciliaciones - Gastos Familiares{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-clock-history"></i> Historial de Conciliaciones</h1>
        <p class="text-muted">Registro de todas las conciliaciones mensuales</p>
    </div>
    <div class="col-auto">
        <a href="{% url 'conciliacion' %}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Volver a Conciliación
        </a>
    </div>
</div>

{% if conciliaciones %}
{% for conciliacion in conciliaciones %}
<div class="card mb-3">
    <div class="card-header {% if conciliacion.estado == 'CERRADA' %}bg-success text-white{% elif conciliacion.estado == 'CANCELADA' %}bg-secondary text-white{% else %}bg-warning{% endif %}">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-month"></i> {{ conciliacion }}
                </h5>
            </div>
            <div class="col-auto">
                <span class="badge {% if conciliacion.estado == 'CERRADA' %}bg-light text-dark{% else %}bg-dark{% endif %}">
                    {{ conciliacion.get_estado_display }}
                </span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-3">
                <strong>Total Gastos del Mes:</strong><br>
                <span class="h4 text-primary">${{ conciliacion.total_gastos|floatformat:0 }}</span>
            </div>
            <div class="col-md-3">
                <strong>Aportantes:</strong><br>
                <span class="h5">{{ conciliacion.detalles.count }}</span>
            </div>
            <div class="col-md-3">
                <strong>Reintegros:</strong><br>
                <span class="h5">{{ conciliacion.reintegros.count }}</span>
            </div>
            <div class="col-md-3">
                <strong>Fecha de Cierre:</strong><br>
                {% if conciliacion.fecha_cierre %}
                {{ conciliacion.fecha_cierre|date:"d/m/Y H:i" }}
                {% else %}
                <span class="text-muted">Pendiente</span>
                {% endif %}
            </div>
        </div>

        {% if conciliacion.cerrada_por %}
        <p class="mb-2">
            <strong>Cerrada por:</strong> {{ conciliacion.cerrada_por.first_name|default:conciliacion.cerrada_por.username }}
        </p>
        {% endif %}

        {% if conciliacion.observaciones %}
        <p class="mb-2">
            <strong>Observaciones:</strong> {{ conciliacion.observaciones }}
        </p>
        {% endif %}

        <!-- Detalles por Aportante -->
        <h6 class="mt-3 mb-2">Detalle por Aportante:</h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Aportante</th>
                        <th class="text-center">% Esperado</th>
                        <th class="text-end">Debe Pagar</th>
                        <th class="text-end">Pagó</th>
                        <th class="text-end">Balance</th>
                        <th class="text-center">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detalle in conciliacion.detalles.all %}
                    <tr>
                        <td><strong>{{ detalle.aportante.nombre }}</strong></td>
                        <td class="text-center">{{ detalle.porcentaje_esperado|floatformat:1 }}%</td>
                        <td class="text-end">${{ detalle.monto_debe_pagar|floatformat:0 }}</td>
                        <td class="text-end">${{ detalle.monto_pago_real|floatformat:0 }}</td>
                        <td class="text-end {% if detalle.balance > 0 %}text-success{% elif detalle.balance < 0 %}text-danger{% endif %}">
                            {% if detalle.balance > 0 %}+{% endif %}${{ detalle.balance|floatformat:0 }}
                        </td>
                        <td class="text-center">
                            {% if detalle.confirmado %}
                            <i class="bi bi-check-circle-fill text-success" title="Confirmado"></i>
                            {% else %}
                            <i class="bi bi-hourglass-split text-warning" title="Pendiente"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Reintegros -->
        {% if conciliacion.reintegros.exists %}
        <h6 class="mt-3 mb-2">Reintegros Necesarios:</h6>
        <div class="list-group">
            {% for reintegro in conciliacion.reintegros.all %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-arrow-right-circle"></i>
                    <strong>{{ reintegro.de_aportante.nombre }}</strong>
                    debe transferir a
                    <strong>{{ reintegro.para_aportante.nombre }}</strong>
                    {% if reintegro.comprobante %}
                    <br><small class="text-muted">Comprobante: {{ reintegro.comprobante }}</small>
                    {% endif %}
                </div>
                <div class="text-end">
                    <h5 class="mb-0 text-primary">${{ reintegro.monto|floatformat:0 }}</h5>
                    {% if reintegro.pagado %}
                    <small class="text-success">
                        <i class="bi bi-check-circle-fill"></i> Pagado
                        {% if reintegro.fecha_pago %}el {{ reintegro.fecha_pago|date:"d/m/Y" }}{% endif %}
                    </small>
                    {% else %}
                    <small class="text-warning">
                        <i class="bi bi-clock"></i> Pendiente
                    </small>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-success mt-3">
            <i class="bi bi-check-circle"></i> <strong>¡Mes equilibrado!</strong> No hubo reintegros necesarios.
        </div>
        {% endif %}
    </div>
    <div class="card-footer text-muted small">
        Creada el {{ conciliacion.fecha_creacion|date:"d/m/Y H:i" }}
    </div>
</div>
{% endfor %}

{% else %}
<div class="alert alert-info">
    <h5><i class="bi bi-info-circle"></i> No hay conciliaciones registradas</h5>
    <p class="mb-0">
        Aún no has cerrado ninguna conciliación mensual.
        <a href="{% url 'conciliacion' %}" class="alert-link">Ve a Conciliación</a>
        y cierra el mes actual cuando todos estén de acuerdo con los reintegros.
    </p>
</div>
{% endif %}

<div class="alert alert-light border mt-4">
    <h6><i class="bi bi-lightbulb"></i> ¿Para qué sirve el historial?</h6>
    <ul class="mb-0">
        <li><strong>Transparencia:</strong> Registro completo de todas las conciliaciones pasadas</li>
        <li><strong>Auditoría:</strong> Consulta quién pagó qué en meses anteriores</li>
        <li><strong>Control:</strong> Verifica que todos los reintegros se hayan realizado</li>
        <li><strong>Histórico:</strong> Analiza patrones de gasto a lo largo del tiempo</li>
    </ul>
</div>
{% endblock %}

