{% extends 'gastos/base.html' %}

{% block title %}Pagar con {{ info_cuenta.nombre }} - Gastos Familiares{% endblock %}

{% block extra_css %}
<style>
    .qr-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        text-align: center;
    }

    .qr-image {
        max-width: 400px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .cuenta-info {
        background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(44, 62, 80, 0.1));
        border-radius: 12px;
        padding: 24px;
        margin: 20px 0;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .copy-btn {
        cursor: pointer;
        color: #3498db;
        margin-left: 8px;
    }

    .copy-btn:hover {
        color: #2980b9;
    }

    .instrucciones {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .instrucciones ol {
        margin: 0;
        padding-left: 20px;
    }

    .instrucciones li {
        margin: 8px 0;
    }

    .upload-zone {
        border: 3px dashed #bdc3c7;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin: 20px 0;
    }

    .upload-zone:hover {
        border-color: #3498db;
        background: rgba(52, 152, 219, 0.05);
    }

    .upload-zone.dragover {
        border-color: #27ae60;
        background: rgba(39, 174, 96, 0.1);
    }

    .countdown {
        font-size: 18px;
        font-weight: bold;
        color: #e74c3c;
        margin: 16px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-6">
                    <span style="font-size: 48px;">{{ info_cuenta.icono }}</span><br>
                    Pagar con {{ info_cuenta.nombre }}
                </h1>
                <p class="text-muted">Suscripción: {{ plan.nombre }} - ${{ plan.precio_mensual|floatformat:0 }}</p>
            </div>

            <div class="row">
                <!-- Columna izquierda: QR y datos -->
                <div class="col-md-6">
                    <div class="qr-container">
                        <h4 class="mb-4">Escanea el código QR</h4>

                        <div class="qr-image">
                            <img src="data:image/png;base64,{{ qr_base64 }}" alt="Código QR" class="img-fluid">
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-qr-code-scan"></i>
                            Abre tu app de {{ info_cuenta.nombre }} y escanea este código
                        </div>

                        <button class="btn btn-outline-primary" onclick="descargarQR()">
                            <i class="bi bi-download"></i> Descargar QR
                        </button>
                    </div>

                    <!-- Datos de cuenta (respaldo) -->
                    <div class="cuenta-info mt-4">
                        <h5 class="mb-3"><i class="bi bi-info-circle"></i> Datos de la cuenta</h5>
                        <div class="info-row">
                            <span><strong>Banco/Método:</strong></span>
                            <span>{{ info_cuenta.nombre }}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Tipo:</strong></span>
                            <span>{{ info_cuenta.tipo }}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Número:</strong></span>
                            <span>
                                {{ info_cuenta.numero }}
                                <i class="bi bi-clipboard copy-btn" onclick="copiar('{{ info_cuenta.numero }}')" title="Copiar"></i>
                            </span>
                        </div>
                        <div class="info-row">
                            <span><strong>Titular:</strong></span>
                            <span>{{ info_cuenta.titular }}</span>
                        </div>
                        {% if info_cuenta.nit %}
                        <div class="info-row">
                            <span><strong>NIT:</strong></span>
                            <span>{{ info_cuenta.nit }}</span>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <span><strong>Monto:</strong></span>
                            <span class="text-primary fw-bold">${{ pago.monto|floatformat:0 }}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Referencia:</strong></span>
                            <span class="font-monospace">
                                {{ referencia }}
                                <i class="bi bi-clipboard copy-btn" onclick="copiar('{{ referencia }}')" title="Copiar"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Columna derecha: Instrucciones y upload -->
                <div class="col-md-6">
                    <div class="instrucciones">
                        <h5><i class="bi bi-list-check"></i> Pasos a seguir:</h5>
                        <ol>
                            {% for instruccion in info_cuenta.instrucciones %}
                            <li>{{ instruccion }}</li>
                            {% endfor %}
                        </ol>
                    </div>

                    <!-- Upload de comprobante -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Subir Comprobante</h5>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm" enctype="multipart/form-data">
                                {% csrf_token %}

                                <div class="mb-3">
                                    <label for="numero_transaccion" class="form-label">
                                        Número de Transacción (Opcional)
                                    </label>
                                    <input type="text" class="form-control" id="numero_transaccion" name="numero_transaccion" placeholder="Ej: 123456789">
                                </div>

                                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('comprobante').click()">
                                    <i class="bi bi-cloud-arrow-up" style="font-size: 48px; color: #95a5a6;"></i>
                                    <p class="mt-3 mb-0">
                                        <strong>Click aquí o arrastra tu comprobante</strong><br>
                                        <small class="text-muted">JPG, PNG o PDF (máx. 5MB)</small>
                                    </p>
                                    <input type="file" id="comprobante" name="comprobante" accept="image/*,.pdf" style="display: none;" onchange="previewFile()">
                                </div>

                                <div id="filePreview" class="mb-3" style="display: none;">
                                    <div class="alert alert-success">
                                        <i class="bi bi-file-earmark-check"></i>
                                        <strong>Archivo seleccionado:</strong> <span id="fileName"></span>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success w-100" id="submitBtn" disabled>
                                    <i class="bi bi-check-circle"></i> Subir Comprobante y Verificar
                                </button>
                            </form>

                            <div id="uploadResult" style="display: none;" class="mt-3"></div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Importante:</strong><br>
                        • El pago será verificado manualmente<br>
                        • La verificación toma entre 10 minutos y 2 horas<br>
                        • Recibirás un correo cuando se apruebe
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Funciones de utilidad
function copiar(texto) {
    navigator.clipboard.writeText(texto).then(() => {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: '¡Copiado!',
                text: 'Texto copiado al portapapeles',
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            alert('Copiado: ' + texto);
        }
    });
}

function descargarQR() {
    const link = document.createElement('a');
    link.href = 'data:image/png;base64,{{ qr_base64 }}';
    link.download = 'qr_pago_{{ referencia }}.png';
    link.click();
}

// Preview de archivo
function previewFile() {
    const input = document.getElementById('comprobante');
    const file = input.files[0];

    if (file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('filePreview').style.display = 'block';
        document.getElementById('submitBtn').disabled = false;
    }
}

// Drag & drop
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('comprobante').files = files;
        previewFile();
    }
});

// Submit form
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const formData = new FormData(e.target);

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Subiendo...';

    try {
        const response = await fetch('{% url "subir_comprobante" pago.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const data = await response.json();
        const resultDiv = document.getElementById('uploadResult');

        if (data.success) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.mensaje;

            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '¡Comprobante subido!',
                    text: data.mensaje,
                    confirmButtonText: 'Ver estado'
                }).then(() => {
                    window.location.href = '{% url "estado_pago" pago.id %}';
                });
            } else {
                setTimeout(() => {
                    window.location.href = '{% url "estado_pago" pago.id %}';
                }, 2000);
            }
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = '<i class="bi bi-x-circle"></i> ' + data.error;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Subir Comprobante y Verificar';
        }

        resultDiv.style.display = 'block';
    } catch (error) {
        console.error('Error:', error);
        const resultDiv = document.getElementById('uploadResult');
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = '<i class="bi bi-x-circle"></i> Error al subir el archivo';
        resultDiv.style.display = 'block';

        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Subir Comprobante y Verificar';
    }
});
</script>
{% endblock %}

